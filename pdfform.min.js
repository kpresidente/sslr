"use strict";if("undefined"==typeof window)var DOMParser=require("xmldom").DOMParser,XMLSerializer=require("xmldom").XMLSerializer,text_encoding=require("text-encoding"),TextEncoder=text_encoding.TextEncoder,TextDecoder=text_encoding.TextDecoder,pako=require("pako");function pdfform(e){"pdf.js"===e&&(e=require("./minipdf_js.js")),e||(e="undefined"!=typeof minipdf_js?minipdf_js:"undefined"!=typeof minipdf?minipdf:require("./minipdf.js"));var r=e.assert;function t(){this.length=0,this.entries=[]}function n(e,r){for(var t=e+"";t.length<r;)t="0"+t;return t}function i(e){var r,t;if(/^[-_/. a-zA-Z0-9]+$/.test(e))return"("+e+")";if(/^[\x00-\x7FäöüÄÖÜß]*$/.test(e)){for(r="(",t=0;t<e.length;t++){var n=e[t];"\\"!==n&&"("!==n&&")"!==n||(r+="\\"),r+=n}return r+=")"}for(r="(",r+="þÿ",t=0;t<e.length;t++){var i=e.charCodeAt(t),a=String.fromCharCode(i>>8);"\\"!==a&&"("!==a&&")"!==a||(r+="\\"),r+=a;var o=String.fromCharCode(255&i);"\\"!==o&&"("!==o&&")"!==o||(r+="\\"),r+=o}return r+=")"}function a(t,n){var o,f;if(e.isRef(t))return t.num+" "+t.gen+" R";if(e.isNum(t))return t;if(e.isBool(t))return t;if(e.isNull(t))return"null";if(e.isName(t))return r(t.name),"/"+t.name;if(e.isString(t))return i(t);if(e.isArray(t)){for(f=["["],o=0;o<t.length;o++)f.push(a(t[o],n));return f.push("]"),f.join(" ")}if(e.isDict(t)){var s=t.map;for(var p in f=["<<"],s)f.push("/"+p+" "+a(s[p],n));return f.push(">>"),f.join("\n")}if(e.isStream(t)){f="",delete t.dict.map.DecodeParms,delete t.dict.map.Filter;var d,m=t.getBytes();return r(m,"expecting byte content from "+JSON.stringify(t)),n?(d=e.buf2str(m),t.dict.map.Length=d.length):(d=e.buf2str(pako.deflate(m)),t.dict.map.Length=d.length,t.dict.map.Filter=[new e.Name("FlateDecode")]),r(e.isDict(t.dict)),f+=a(t.dict,n),f+="\nstream\n",f+=d,f+="\nendstream\n"}throw new Error("Unknown node type "+JSON.stringify(t))}function o(t){this.entries=t.get_xref_entries(),r(e.isArray(this.entries),"xref entries should be an Array")}function f(r,t){if(r.acroForm)for(var n=r.acroForm.map.Fields.slice();n.length>0;){var i=n.shift();if(e.isRef(i)){var a=i;(i=r.fetch(i))._pdfform_ref=a}i.map&&i.map.Kids&&i.map.Opt&&i.map.FT&&"Btn"===i.map.FT.name?(i._pdfform_spec={type:"radio",options:i.map.Opt},t(i)):i.map&&i.map.Kids?n.push.apply(n,i.map.Kids):i.map&&i.map.Type&&"Annot"==i.map.Type.name&&i.map.T&&t(i)}else r.fetch(r.root.map.Pages).map.Kids.forEach((function(e){var n=r.fetch(e).map.Annots;r.fetch(n).forEach((function(e){var n=r.fetch(e);n._pdfform_ref=e,n._inpage_annot=!0,n.map&&n.map.Type&&"Annot"==n.map.Type.name&&n.map.T&&t(n)}))}))}function s(e){if(!e.startsWith("þÿ"))return e;for(var r="",t=2;t<e.length;t+=2)r+=String.fromCharCode(e.charCodeAt(t)<<8|e.charCodeAt(t+1));return r}return t.prototype={write_str:function(e){this.length+=e.length,r("string"==typeof e),this.entries.push(e)},write_buf:function(e){this.length+=e.length,r(e instanceof Uint8Array,"Expected a Uint8Array, but got "+e),this.entries.push(e)},get_uint8array:function(){var e=new Uint8Array(this.length),t=0;return this.entries.forEach((function(r){if("string"==typeof r)for(var n=0,i=r.length;n<i;n++,t++)e[t]=r.charCodeAt(n);else e.set(r,t),t+=r.length})),r(t===this.length),e},position:function(){return this.length}},o.prototype={add:function(e,r){var t={obj:e,gen:r,num:this.entries.length,uncompressed:"added"};return this.entries.push(t),t},update:function(e,t){r(void 0!==e.num),r(void 0!==e.gen);var n={obj:t,gen:e.gen,num:e.num,uncompressed:"added"};return this.entries[n.num]=n,n},write_object:function(e,t,n){t.offset=e.position(),r(void 0!==t.num);var i=a(t.obj,n);e.write_str(t.num+" "+t.gen+" obj\n"),e.write_str(i),e.write_str("\nendobj\n")},write_xref_stream:function(n,i,a){var o={Type:new e.Name("XRef"),Size:this.entries.length+1,Root:a,W:[1,4,1],Index:[]};void 0!==i&&(o.Prev=i);var f=0,s=!0,p=new t,d=this.add("__xref_stream__",0);d.offset=n.position(),this.entries.forEach((function(e,t){"added"===e.uncompressed?(f++,s?(s=!1,o.Index.push(t),o.Index.push(1)):o.Index[o.Index.length-1]++,r(void 0!==e.offset,"entry should have an offset"),p.write_buf(new Uint8Array([e.uncompressed?1:2,e.offset>>24,e.offset>>16&255,e.offset>>8&255,255&e.offset,e.gen]))):s=!0}));var m=p.get_uint8array();o.Length=6*(f+1);var u=e.newStream(o,m);d.obj=u,this.write_object(n,d,!0)},write_xref_table:function(t,i,o){var f=this.entries.filter((function(e){return!e.is_free})),s=1+f.length;t.write_str("xref\n"),t.write_str("0 "+s+"\n"),t.write_str("0000000000 65535 f\r\n"),f.forEach((function(e){r(void 0!==e.offset,"entry should have an offset"),t.write_str(n(e.offset,10)+" "+n(e.gen,5)+" n\r\n")})),t.write_str("trailer\n");var p=new e.Dict({Size:s,Root:o});t.write_str(a(p,!0))}},{transform:function(n,i){var a=e.parse(new Uint8Array(n));r(a.startXRef);var p=new o(a),d=a.get_root_id(),m=new e.Ref(d,0),u=new t;u.write_buf(new Uint8Array(n)),f(a,(function(r){var t=function(e,r){var t=s(e.map.T);if(t in r)return r[t][0];var n=/^(.*)\[([0-9]+)\]$/.exec(t);return n&&n[1]in r?r[n[1]][n[2]]:void 0}(r,i);if(void 0!==t){if(r._pdfform_spec){var n=r._pdfform_spec.type;if("radio"===n){var o=r._pdfform_spec.options.indexOf(t);if(-1===o)return;var f=r.map.Kids[o];if(!f)throw new Error("Cannot find kid #"+o+" (value="+t+")");if(!e.isRef(f))throw new Error("radio kid is not a reference");var d=a.fetch(f);d.map.AS=d.map.V=d.map.DV=new e.Name("Yes");var m=p.update(f,d);return void p.write_object(u,m)}throw new Error("Unsupported spec type "+n)}var c=r.map.FT.name;if("Tx"==c)r.map.V=""+t;else if("Btn"==c)r.map.AS=r.map.V=r.map.DV=t?new e.Name("Yes"):new e.Name("Off");else{if("Ch"!=c){if("Sig"==c)return;throw new Error("Unsupported input type "+r.map.FT.name)}r.map.V=""+t}var h=r._pdfform_ref,_=p.update(h,r);p.write_object(u,_)}}));var c=a.get_acroform_ref();if(c)if(a.acroForm.map.NeedAppearances=!0,e.isRef(c)){var h=p.update(c,a.acroForm);p.write_object(u,h)}else{a.root.map.AcroForm=a.acroForm;var _=p.update(m,a.root);p.write_object(u,_)}!function(t,n,i,a,o){if(t.acroForm){var f=t.acroForm.map.XFA;if(f){var s=f.indexOf(a);r(s>=0);var p=f[s+1],d=t.fetch(p);r(e.isStream(d),"XFA section node should be a stream");var m=d.getBytes();r(m);var u=o(new TextDecoder("utf-8").decode(m)),c=new TextEncoder("utf-8").encode(u),h=e.newStream(d.dict.map,c);r(e.isStream(h));var _=n.update(p,h);n.write_object(i,_)}}}(a,p,u,"datasets",(function(e){e=e.replace(/\n(\/?>)/g,"$1\n");var r=(new DOMParser).parseFromString(e,"application/xml");for(var t in i)for(var n=r.getElementsByTagName(t),a=0;a<n.length;a++){var o=i[t][a];if(void 0!==o){for(var f=n[a];f.firstChild;)f.removeChild(f.firstChild);"boolean"==typeof o&&(o=o?1:0),f.appendChild(r.createTextNode(o))}}return e=(new XMLSerializer).serializeToString(r)}));var l=u.position();return"table"===a.xref_type?p.write_xref_table(u,a.startXRef,m):p.write_xref_stream(u,a.startXRef,m),u.write_str("\nstartxref\n"),u.write_str(l+"\n"),u.write_str("%%EOF"),u.get_uint8array()},list_fields:function(r){var t=e.parse(new Uint8Array(r)),n={};return f(t,(function(e){var r,t=s(e.map.T),i=t,a=0,o=/^(.+?)\[([0-9]+)\]$/.exec(t);if(o&&(i=o[1],a=parseInt(o[2],10)),e._pdfform_spec)r=e._pdfform_spec;else{var f=e.map.FT.name;if("Tx"===f)r={type:"string"};else if("Btn"===f)r={type:"boolean"};else{if("Ch"!==f){if("Sig"===f)return;throw new Error("Unsupported input type"+f)}r={type:"select",options:e.map.Opt.slice()}}}n[i]||(n[i]=[]),n[i][a]=r})),n},_serialize_str:i,_decode_str:s}}pdfform.transform=function(e,r){return pdfform().transform(e,r)},"undefined"!=typeof module&&(module.exports=pdfform);