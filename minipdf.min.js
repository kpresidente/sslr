var minipdf=function(){"use strict";var t=function(t){this.name=t};var r=function(t){this.map=t};var e=function(t,e){this.map=t,this.content=e,this.dict=new r(t)};e.prototype.getBytes=function(){return this.content};var s=function(t,r){this.num=t,this.gen=r};function n(t){return t instanceof s}function i(t){return t instanceof Array}function o(t,r){if(!t)throw r||(r="Assertion failed"),new Error(r)}function a(t,r){var e,s=1;if(r){if(s=r.Predictor,e=r.Columns,r.Colors&&1!=r.Colors)throw new Error("Unsupported predictor Colors value: "+r.Colors);if(r.BitsPerComponent&&8!=r.BitsPerComponent)throw new Error("Unsupported predictor BitsPerComponent value: "+r.BitsPerComponent)}var n=pako.inflate(t);if(1==s)return n;if(o(e>0,"columns must be set for PNG predictors"),!(s>=10&&s<=15))throw new Error("Unsupported predictor "+s);return n=function(t,r){var e=r+1,s=t.length/e;o(s%1==0,"Invalid column value "+e+" for image width "+t.length);for(var n=new Uint8Array(r*s),i=0;i<s;i++){var a,f=t[i*e];if(0===f)for(a=0;a<r;a++)n[i*r+a]=t[i*e+1+a];else{if(2!==f)throw new Error("Unsupported PNG filter "+f);for(a=0;a<r;a++){var h=0===i?0:n[(i-1)*r+a];n[i*r+a]=h+t[i*e+1+a]&255}}}return n}(n,e)}var f=function(t){this._cached_object_streams={},this.buf=t,this.reader=new h(t),function(t){if(!p(t,0,"%PDF-"))throw new Error("Does not look like a PDF file!")}(t),this.startXRef=function(t){var r=u(t,t.length-40,t.length),e=/startxref\s*([0-9]+)/.exec(r);if(!e)throw new Error("Cannot find startxref!");return parseInt(e[1])}(t),this.reader.pos=this.startXRef;var r=this.reader.parse_xref();this.xref=r.xref,o(i(this.xref)),this.meta=r.meta,o(this.meta.Root,"meta.Root missing"),o(n(this.meta.Root),"meta.root should be Ref"),this.root=this.fetch(this.meta.Root),this.xref_type=this.reader.xref_type;var e=this.get_acroform_ref();n(e)?this.acroForm=this.fetch(e):this.acroForm=e};f.prototype.get_root_id=function(){return this.meta.Root.num},f.prototype.get_xref_entries=function(){return this.xref},f.prototype.get_acroform_ref=function(){return this.root.map.AcroForm},f.prototype.fetch=function(t,r){o(t instanceof s);var e=this.xref[t.num];if(!e)throw new Error("Cannot find object "+t.num+" in xref table");if(0===e.type)throw new Error("Cannot fetch a free object");if(2==e.type){if(r)throw new Error("Cannot fetch object stream inside object stream");if(0!==t.gen)throw new Error("Object with reference "+t.gen+" cannot be found in object stream");var n=this._cached_object_streams[e.offset];if(!n)n=function(t){o("ObjStm"===t.map.Type.name,"Strange Type for an object stream: "+JSON.stringify(t.map.Type.name));for(var r=u(t.content,0,t.map.First),e=/\s*([0-9]+)\s+([0-9]+)/g,s=[],n=new h(t.content),i=0;i<t.map.N;i++){var a=e.exec(r);if(!a)throw new Error("Expected "+t.map.N+" objects in this object stream, failed to read number "+i);var f=parseInt(a[1],10),p=parseInt(a[2],10);n.pos=p+t.map.First,s[f]=n.parse()}return s}(this.fetch(new s(e.offset,0),!0)),this._cached_object_streams[e.offset]=n;if(!(t.num in n))throw new Error("Could not find object "+t.num+" in object stream with entries "+JSON.stringify(Object.keys(n)));return n[t.num]}if(t.gen!=e.gen)throw new Error("Invalid generation: Asked for "+t.gen+", table has "+e.gen);this.reader.pos=e.offset;var i=this.reader.parse_object();if(i.num!==t.num)throw new Error("Expected to read object with ID "+t.num+", but found "+i.num);if(i.gen!==t.gen)throw new Error("Expected to read object with gen "+t.gen+", but found "+i.gen);return i.obj};var h=function(t){o(t instanceof Uint8Array,"Expected a buffer of type Uint8Array"),o(1===t.BYTES_PER_ELEMENT,"not a Uint8Array!"),this.buf=t,this.pos=0};function p(t,r,e){for(var s=0;s<e.length;s++)if(e.charCodeAt(s)!=t[r+s])return!1;return!0}function u(t,r,e){void 0===r&&(r=0),void 0===e&&(e=t.length);for(var s=Math.min(e,t.length),n="",i=r;i<s;i++)n+=String.fromCharCode(t[i]);return n}return h.prototype={skip_space:function(){for(;this.pos<this.buf.length;){var t=this.buf[this.pos];if(9!=t&&10!=t&&13!=t&&32!=t)break;this.pos++}},skip_start:function(t){return!!p(this.buf,this.pos,t)&&(this.pos+=t.length,!0)},read_uint:function(t){for(var r=0;t>0;)o(void 0!==this.buf[this.pos],"reading uint at position "+this.pos+" of "+this.buf.length),r=(r<<8|255&this.buf[this.pos])>>>0,this.pos++,t--;return r},parse_string:function(){for(var t="",r=1;this.pos<this.buf.length;){var e=String.fromCharCode(this.buf[this.pos]);if(this.pos++,")"==e){if(0===--r)break;t+=e}else if("("==e)r++,t+=e;else if("\\"==e)switch(e=String.fromCharCode(this.buf[this.pos]),this.pos++,e){case"n":t+="\n";break;case"r":t+="\r";break;case"t":t+="\t";break;case"\r":case"\n":break;case"\\":case"(":case")":t+=e;break;default:throw new Error('Unsupported escape "'+e+'"')}else t+=e}return t},parse_hex_string:function(){for(var t=this.pos;this.pos<this.buf.length&&this.buf[this.pos]!=">".charCodeAt(0);)this.pos++;var r=u(this.buf,t,this.pos);if(this.pos++,r.length%2==1&&(r+="0"),!/^[0-9A-Fa-f]*$/.test(r))throw new Error("Invalid hex string "+r);return r.replace(/([0-9A-Fa-f]{2})/g,(function(){return String.fromCharCode(parseInt(arguments[1],16))}))},parse_num:function(){for(var t=0,r=this.pos;this.pos<this.buf.length;){var e=this.buf[this.pos];if(!(48<=e&&e<=57))break;t=10*t+e-48,this.pos++}if(r===this.pos)throw new Error("Not an ASCII number byte: "+this.buf[this.pos]);return t},parse_name:function(){for(var r=this.pos,e=[0,9,13,10,32,40,41,60,62,91,93,123,125,47,37];this.pos<this.buf.length&&!(e.indexOf(this.buf[this.pos])>=0);)this.pos++;var s=u(this.buf,r,this.pos);return s=s.replace(/#([0-9a-fA-F]{2})/g,(function(t,r){return String.fromCharCode(parseInt(r,16))})),new t(s)},parse_array:function(){for(var t=[];this.skip_space(),93!=this.buf[this.pos];){var r=this.parse();t.push(r)}return this.pos++,t},parse_dict:function(){for(var t={};this.pos<this.buf.length&&(this.skip_space(),!this.skip_start(">>"));){if(!this.skip_start("/"))throw new Error("Key is not a name in dict");var e=this.parse_name(),s=this.parse();t[e.name]=s}var n=this.pos;return this.skip_space(),this.skip_start("stream\r\n")||this.skip_start("stream\n")||this.skip_start("stream")?this.parse_stream_content(t):(this.pos=n,new r(t))},parse_stream_content:function(t){if("number"!=typeof t.Length)throw new Error("Stream Length field missing or invalid: "+JSON.stringify(t.Length));if(this.pos+t.Length>this.buf.length)throw new Error("Stream Length too large");var r=this.buf.subarray(this.pos,this.pos+t.Length);if(this.pos+=t.Length,this.skip_space(),!this.skip_start("endstream"))throw new Error("Missing endstream");if(t.Filter)for(var s=t.Filter instanceof Array?t.Filter:[t.Filter],n=t.DecodeParms instanceof Array?t.DecodeParms:[t.DecodeParms],i=0;i<s.length;i++){var o=n[i];switch(s[i].name){case"FlateDecode":r=a(r,o?o.map:o);break;default:throw new Error("Unsupported filter: "+JSON.stringify(s[i].name))}}return new e(t,r)},parse:function(){if(this.skip_space(),this.skip_start("<<"))return this.parse_dict();if(this.skip_start("["))return this.parse_array();if(this.skip_start("("))return this.parse_string();if(this.skip_start("<"))return this.parse_hex_string();if(this.skip_start("/"))return this.parse_name();if(this.skip_start("true"))return!0;if(this.skip_start("false"))return!1;if(this.skip_start("null"))return null;var t=u(this.buf,this.pos,this.pos+32),r=/^([0-9]+)\s+([0-9]+)\s+R/.exec(t);if(r)return this.pos+=r[0].length,new s(parseInt(r[1],10),parseInt(r[2],10));if(r=/^[+-]?(?:[0-9]*\.[0-9]*|[0-9]+)/.exec(t))return this.pos+=r[0].length,parseFloat(r[0]);throw new Error("Unable to parse "+u(this.buf,this.pos,this.pos+40))},parse_xref:function(){var t;if(p(this.buf,this.pos,"xref"))return this.xref_type="table",this.parse_xref_table();this.xref_type="stream";var r=this.parse_object().obj,s=[];if("Prev"in r.map){var n=this.pos;this.pos=r.map.Prev,s=this.parse_xref().xref,this.pos=n}o(r instanceof e,"XRefs should be a stream, got "+JSON.stringify(r)+" instead"),o("XRef"===r.map.Type.name,"XRef table should be of Type XRef"),o(3==r.map.W.length);var i=r.map.W[0];o(i<=4);var a=r.map.W[1];o(a>=1&&a<=4);var f=r.map.W[2];o(f>=1&&f<=4),o(r.content.length%(i+a+f)==0,"content is "+r.content.length+" bytes long, each entry is "+JSON.stringify(r.map.W));var u=r.content.length/(i+a+f),c=r.map.Index;if(c){var m=0;for(t=0;t<c.length;t+=2)o("number"==typeof c[t]),o("number"==typeof c[t+1]),m+=c[t+1];o(m==u,"Invalid xref stream index: index says "+m+" objects, but space for "+u)}else c=[0,u];for(var l=new h(r.content),b=0;b<c.length;b+=2){var d=c[b],g=c[b+1];for(t=0;t<g;t++){var _=1;i&&(_=l.read_uint(i));var v={type:_,offset:l.read_uint(a),gen:l.read_uint(f)};0===_?v.free=!0:v.uncompressed=2!=_,s[d+t]=v}}return o(l.at_eof()),{meta:r.map,xref:s}},parse_object:function(){var t=u(this.buf,this.pos,this.pos+32),r=/^([0-9]+)\s+([0-9]+)\s+obj/.exec(t);if(!r)throw new Error("Missing object ID: "+t);var e=parseInt(r[1],10),s=parseInt(r[2],10);this.pos+=r[0].length;var n=this.parse();if(this.skip_space(),!this.skip_start("endobj"))throw new Error("endobj missing, current str: "+JSON.stringify(u(this.buf,this.pos,this.pos+32)));return{obj:n,num:e,gen:s}},parse_xref_table:function(){if(!this.skip_start("xref"))throw new Error("xref table does not start with xref!");this.skip_space();for(var t=this.parse_num(),r=[],e=0;e<t;e++)r.push(void 0);for(this.skip_space(),this.parse_num();this.skip_space(),!this.skip_start("trailer");){var s=this.parse_num();this.skip_space();var n=this.parse_num();this.skip_space();var i=this.buf[this.pos];if(102==i||110==i)this.pos++,r.push({offset:s,gen:n,is_free:102===i});else for(;r.length<s;)r.push(void 0)}var o=this.parse();o.map.Prev&&(this.pos=o.map.Prev,function(t,r){for(var e=Math.max(t.length,r.length),s=1;s<e;s++)r[s]&&(t[s]||(t[s]=r[s]))}(r,this.parse_xref_table().xref));return{xref:r,meta:o.map}},at_eof:function(){return this.pos==this.buf.length}},{parse:function(t){return new f(t)},PDFDocument:f,isName:function(r){return r instanceof t},isStream:function(t){return t instanceof e},isDict:function(t){return t instanceof r},isRef:n,isNum:function(t){return"number"==typeof t},isArray:i,isString:function(t){return"string"==typeof t},isBool:function(t){return"boolean"==typeof t},isNull:function(t){return null===t},newStream:function(t,r){return o(r instanceof Uint8Array,"stream content must be an Uint8Array"),new e(t,r)},assert:o,buf2str:u,str2buf:function(t){for(var r=new Uint8Array(t.length),e=0,s=t.length;e<s;e++)r[e]=t.charCodeAt(e);return r},PDFReader:h,Name:t,Dict:r,Ref:s,Stream:e}}();if("undefined"!=typeof module&&"undefined"!=typeof require){var pako=require("pako");module.exports=minipdf}